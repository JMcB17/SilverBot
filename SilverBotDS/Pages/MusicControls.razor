@page "/musiccontrols"
@using System.Net
@using System.Text
@using System.IO
@using Microsoft.AspNetCore.Http
@using SilverBotDS.Objects
@using DSharpPlus
@using DSharpPlus.Entities
@using System.Diagnostics
@using SilverBotDS.WebHelpers
@using SilverBotDS
@using Microsoft.JSInterop
@using Lavalink4NET
@using SilverBotDS.Objects.Classes
@using SilverBotDS.Converters
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager uriHelper
@using System.Threading
@inject Config config
@{
    if (!config.UseLavaLink)
    {
        uriHelper.NavigateTo("/", forceLoad: true);
    }
}

@inject DiscordClient Discord
@inject IJSRuntime jsRuntime
@inject LavalinkNode Lavalink
@{
    if (string.IsNullOrEmpty(SessionHelper.GetObjectFromJson<string>(HttpContextAccessor.HttpContext.Session, "accessToken")))
    {
        uriHelper.NavigateTo("/login", forceLoad: true);
    }
}
@{
    DiscordUser user = Discord.GetUserAsync(SessionHelper.GetUserInfoFromSession(HttpContextAccessor.HttpContext.Session).UId).GetAwaiter().GetResult();
    var djattribute = new RequireDJAttribute();

}
@foreach (var guild in Discord.Guilds.Values.Where(x => x.Members.ContainsKey(user.Id) && x.Members[user.Id].VoiceState is not null && x.Members[user.Id].VoiceState.Channel is not null && Lavalink.HasPlayer(x.Id) && Lavalink.GetPlayer<BetterVoteLavalinkPlayer>(x.Id).VoiceChannelId == x.Members[user.Id].VoiceState.Channel.Id))
{
    <div class="window" style="max-width: 610px">
        <div class="title-bar">
            <div class="title-bar-text">@guild.Members[user.Id].VoiceState.Channel.Name in @guild.Name</div>
            <div class="title-bar-controls">
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            @code{

                ulong userid;
                private async Task ToggleStatePress(BetterVoteLavalinkPlayer player)
                {
                    if (player.State is Lavalink4NET.Player.PlayerState.Paused)
                    {

                        await player.ResumeAsync();
                    }
                    else if (player.State is Lavalink4NET.Player.PlayerState.Playing)
                    {
                        await player.PauseAsync();
                    }

                }
                private async Task VoteSkipPress(BetterVoteLavalinkPlayer player)
                {
                    var votestatus = await player.VoteAsync(userid);
                    //TO:DO possibly tell user count of people that voted or if the song was skipped
                }
                private async Task ForceSkipPress(BetterVoteLavalinkPlayer player)
                {
                    await player.SkipAsync();
                }
                private void ShufflePress(BetterVoteLavalinkPlayer player)
                {
                    player.Queue.Shuffle();
                }
                private void NotLoopingPress(BetterVoteLavalinkPlayer player)
                {
                    player.LoopSettings = LoopSettings.NotLooping;
                }
                private void LoopingSongPress(BetterVoteLavalinkPlayer player)
                {
                    player.LoopSettings = LoopSettings.LoopingSong;
                }
                private void LoopingQueuePress(BetterVoteLavalinkPlayer player)
                {
                    player.LoopSettings = LoopSettings.LoopingQueue;
                }
            }
            @{
                string ToggleStateText = "Resume / Pause";
                BetterVoteLavalinkPlayer player = Lavalink.GetPlayer<BetterVoteLavalinkPlayer>(guild.Id);
                userid = user.Id;
                if (player.State is Lavalink4NET.Player.PlayerState.Paused)
                {
                    ToggleStateText = "▶️";
                }
                else if (player.State is Lavalink4NET.Player.PlayerState.Playing)
                {
                    ToggleStateText = "⏸";
                }

            }
            <input id="ToggleState" type="button" @onclick="@(async (e) => { await ToggleStatePress(player); if (player.State is Lavalink4NET.Player.PlayerState.Paused) { ToggleStateText = "▶️"; } else if (player.State is Lavalink4NET.Player.PlayerState.Playing) { ToggleStateText = "⏸";} })" value="@ToggleStateText" runat="server" /><!--Play or Pause-->
            <input id="VoteSkip" type="button" @onclick="@(async (e) => await VoteSkipPress(player))" value="VoteSkip" />
            @if (guild.Members[user.Id].Roles.Any(e => e.CheckPermission(DSharpPlus.Permissions.ManageChannels) == DSharpPlus.PermissionLevel.Allowed || e.Name.ToLower().Contains("dj")) || (guild.Members[user.Id].VoiceState.Channel.Users.LongCount(x => !x.IsBot) == 1))
            {
                <input id="ForceSkip" type="button" @onclick="@(async(e) => await ForceSkipPress(player))" value="Just skip it™ (DJ only)" /><!--Requires dj-->
                <input id="Shuffle" type="button" @onclick="@(e =>  ShufflePress(player))" value="🔀Shuffle" /> <!--Requires dj-->
            }
            <input id="NoLoop" type="button" @onclick="@(e =>  NotLoopingPress(player))" value="Do not loop" />
            <input id="LoopSong" type="button" @onclick="@(e =>  LoopingSongPress(player))" value="Loop song" />
            <input id="LoopQueue" type="button" @onclick="@(e => LoopingQueuePress(player))" value="Loop queue" />
        </div>
    </div>
}